pipeline {
    agent any

    environment {
        KUBECTL = '/usr/local/bin/kubectl'
        HELM = '/usr/local/bin/helm'
        AWS_DEFAULT_REGION = 'us-east-1'
    }

    parameters {
        string(name: 'CLUSTER_NAME', defaultValue: 'devops-cluster', description: 'EKS cluster name')
        choice(name: 'CLEANUP_LEVEL', choices: ['APPS_ONLY', 'APPS_AND_MONITORING', 'FULL_CLUSTER'], description: 'What to clean up?')
        booleanParam(name: 'DELETE_ECR_REPO', defaultValue: false, description: 'Delete ECR repository?')
        booleanParam(name: 'CONFIRM_DELETION', defaultValue: false, description: 'I understand this will delete resources')
    }

    stages {

        stage('Validate Confirmation') {
            steps {
                script {
                    if (!params.CONFIRM_DELETION) {
                        error("Cleanup cancelled - CONFIRM_DELETION must be checked")
                    }
                    echo "=== CLEANUP LEVEL: ${params.CLEANUP_LEVEL} ==="
                }
            }
        }

        stage('Configure kubectl') {
            steps {
                script {
                    echo "Configuring kubectl for cluster: ${params.CLUSTER_NAME}"
                    sh "aws eks update-kubeconfig --region ${AWS_DEFAULT_REGION} --name ${params.CLUSTER_NAME}"
                    sh "kubectl cluster-info"
                }
            }
        }
        
        stage('Cleanup Application') {
            when {
                expression { 
                    params.CLEANUP_LEVEL in ['APPS_ONLY', 'APPS_AND_MONITORING', 'FULL_CLUSTER'] 
                }
            }
            steps {
                script {
                    echo "=== Cleaning up Application Resources ==="
                    
                    // Delete application deployment and service
                    sh '''
                    kubectl delete deployment devops-app -n default || true
                    kubectl delete service devops-app -n default || true
                    
                    # Wait for LoadBalancer to be deleted
                    echo "Waiting for LoadBalancer deletion..."
                    sleep 30
                    
                    # Verify deletion
                    kubectl get all -n default
                    '''
                }
            }
        }

        stage('Cleanup CloudWatch') {
            when {
                expression { 
                    params.CLEANUP_LEVEL in ['APPS_AND_MONITORING', 'FULL_CLUSTER'] 
                }
            }
            steps {
                script {
                    echo "=== Cleaning up CloudWatch Container Insights ==="
                    
                    sh '''
                    # Delete CloudWatch agents
                    kubectl delete namespace amazon-cloudwatch || true
                    
                    # Wait for cleanup
                    sleep 10
                    '''
                }
            }
        }
        
        stage('Cleanup ArgoCD') {
            when {
                expression { 
                    params.CLEANUP_LEVEL in ['APPS_AND_MONITORING', 'FULL_CLUSTER'] 
                }
            }
            steps {
                script {
                    echo "=== Cleaning up ArgoCD ==="
                    
                    sh '''
                    # Delete ArgoCD application first
                    kubectl delete application devops-project -n argocd || true
                    
                    # Delete ArgoCD installation
                    kubectl delete -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml || true
                    
                    # Wait for resources to terminate
                    sleep 30
                    
                    # Delete namespace
                    kubectl delete namespace argocd || true
                    '''
                }
            }
        }

        stage('Cleanup Prometheus & Grafana') {
            when {
                expression { 
                    params.CLEANUP_LEVEL in ['APPS_AND_MONITORING', 'FULL_CLUSTER'] 
                }
            }
            steps {
                script {
                    echo "=== Cleaning up Prometheus & Grafana ==="
                    
                    sh '''
                    # List current Helm releases
                    helm list -n prometheus
                    
                    # Uninstall Prometheus stack (correct release name)
                    helm uninstall kube-prometheus-stack -n prometheus || true
                    
                    # Wait for resources to terminate
                    sleep 30
                    
                    # Delete namespace
                    kubectl delete namespace prometheus || true
                    
                    # Remove Helm repositories
                    helm repo remove stable || true
                    helm repo remove prometheus-community || true
                    '''
                }
            }
        }

        stage('Cleanup ECR Repository') {
            when {
                expression { params.DELETE_ECR_REPO }
            }
            steps {
                script {
                    echo "=== Deleting ECR Repository ==="
                    
                    sh '''
                    # Delete ECR repository with correct name
                    aws ecr delete-repository \
                      --repository-name devops-project \
                      --region us-east-1 \
                      --force || echo "Repository not found or already deleted"
                    '''
                }
            }
        }

        stage('Final Verification') {
            steps {
                script {
                    echo "=== Verifying Cleanup ==="
                    
                    sh '''
                    echo "Remaining resources in default namespace:"
                    kubectl get all -n default
                    
                    echo ""
                    echo "Remaining namespaces:"
                    kubectl get namespaces | grep -E "argocd|prometheus|amazon-cloudwatch" || echo "All monitoring namespaces cleaned"
                    
                    echo ""
                    echo "Remaining LoadBalancers:"
                    kubectl get svc -A -o wide | grep LoadBalancer || echo "No LoadBalancers found"
                    
                    echo ""
                    echo "ECR Repositories:"
                    aws ecr describe-repositories --region us-east-1 --query 'repositories[*].repositoryName' || true
                    '''
                }
            }
        }
		
    }

    post {
        success {
            echo 'Cleanup completed successfully!'
            echo "Cleanup level: ${params.CLEANUP_LEVEL}"
            script {
                if (params.CLEANUP_LEVEL == 'FULL_CLUSTER') {
                    echo "Remember to run 'terraform destroy' to delete EKS cluster and VPC"
                }
            }
        }
        failure {
            echo 'Cleanup failed! Some resources may still exist.'
            echo 'Check logs above and manually verify resources.'
        }
        always {
            echo "=== Cleanup Summary ==="
            echo "Cluster: ${params.CLUSTER_NAME}"
            echo "Level: ${params.CLEANUP_LEVEL}"
            echo "ECR Deleted: ${params.DELETE_ECR_REPO}"
        }
    }
}